!function(e){"use strict";var t="jquery_fm",n=function(t,n){return this.$T=e(t),this._options=e.extend(!0,{autoHideBreadcrumb:!1},n),this._currentFolder="/",this._enableDragDrop=window.FormData&&"draggable"in document.createElement("span"),this._init(t,n),this};n.prototype._init=function(t,n){var a=this,i=a.$fm=e('<div class="jquery_fm" />').appendTo(e(t).empty()),o=a.$explorer=e('<div class="explorer" />').appendTo(i),r=a.$files=e('<div class="files" />').appendTo(o),s=e('<div class="upload-tools" />');if(n.allow_upload){if(e('<a class="btn btn-success upload" />').text(n.strings.add_file).prepend('<i class="icon-plus"></i>').append(e('<input type="file" name="files[]" multiple="">').change(function(){a._upload(this.files);var t=e(this).clone(!0);e("<form></form>").append(t)[0].reset(),e(this).replaceWith(t)})).appendTo(s),a._enableDragDrop){jQuery.event.props.push("dataTransfer");var l=n.drag_anywhere?e("body"):o;l.bind("drop dragenter dragover",function(t){var n=t.originalEvent&&t.originalEvent.dataTransfer;n&&-1!==e.inArray("Files",n.types)&&(t.preventDefault(),"drop"==t.type?a._upload(n.files):(n.dropEffect="copy",l.toggleClass("drag-hover",!0)))}).bind("drop mouseleave dragend dragleave",function(){l.toggleClass("drag-hover",!1)}),e('<div class="drag-drop-message" />').append('<i class="icon-download"></i>').append(n.strings.drop_files).append("<br />").append(e("<small />").text(n.strings.max_file_size.replace("%",n.max_file_size_readable))).appendTo(o)}e(document).on("paste",function(t){var n=t.originalEvent&&t.originalEvent.clipboardData&&t.originalEvent.clipboardData.items,i=[];n&&n.length&&(e.each(n,function(e,t){var n=t.getAsFile&&t.getAsFile();n&&i.push(n)}),a._upload(i))})}n.allow_folders&&e('<a class="btn btn-info folder" />').text(n.strings.create_folder).prepend('<i class="icon-folder-open"></i>').click(function(){return a._ask(a._options.strings.create_folder,a._options.strings.create_folder_prompt,!0,function(e){a._request(null,"create_folder",{name:e},function(e){e.file&&a._createFile(e.file).hide().appendTo(a.$files).show("slow")})}),!1}).appendTo(s),s.children().length>0&&i.append(s),"undefined"==typeof n.files?a.navigateTo("/"):e(n.files).each(function(){r.append(a._createFile(this))}),a._updateBreadcrumb()},n.prototype.navigateTo=function(t){var n=this;if(n._options.allow_folders){t=t.replace(/\/+/g,"/");var a=n.$explorer.find(".files").fadeOut("normal",function(){e(this).html('<div class="loader" />').fadeIn("normal")});n._request(null,"read",{folder:t},function(i){n._currentFolder=t,a.stop(!0,!0).fadeTo("normal",1).empty(),e(i.files).each(function(){n._createFile(this).hide().appendTo(n.$files).fadeTo("slow",1)}),n._updateBreadcrumb()},function(){a.stop(!0,!0).empty().append(e('<a href="#" />').text(n._options.strings.try_again).click(function(){n.navigateTo(t)}))})}return this.$T},n.prototype._request=function(t,n,a,i,o,r){var s,l=this,d={};return a instanceof FormData?(s=a,s.append("action",n),d.processData=!1,d.contentType=!1):(s=e.extend({action:n},a),"undefined"==typeof s.folder&&(s.folder=l._currentFolder)),r&&(d.xhr=function(){var e=jQuery.ajaxSettings.xhr()||new window.XMLHttpRequest;return e.upload&&e.upload.addEventListener("progress",function(e){e.lengthComputable&&r({loaded:event.loaded,total:event.total,progress:event.loaded/event.total*100|0})},!1),e}),d=e.extend(d,{type:"POST",url:l._options.ajax_endpoint,data:s,dataType:"json",cache:!1,success:function(n){t&&t.find(".error").fadeOut("slow",function(){e(this).remove()}),i&&i(n)},error:function(n){var a=n.responseJSON&&n.responseJSON.message,i=l._options.strings[a]||l._options.strings.error;if(t)l._setError(t,i);else{var r=e("<p />").append(e('<span class="label label-danger" />').text(i)).hide().prependTo(l.$fm).fadeIn();window.setTimeout(function(){r.fadeOut("slow",function(){r.remove()})},2e4)}o&&o(s)}}),e.ajax(d)},n.prototype._setError=function(t,n){e('<span class="error" />').text("!").attr("title",n).hide().prependTo(t).fadeOut("fast").fadeIn("fast").fadeOut("fast").fadeIn("fast").fadeOut("fast").fadeIn("fast"),t.attr("title",n).find(".cancel").remove()},n.prototype._findByName=function(t){var n=this;return n.$files.find(".file").filter(function(){return e(this).data("file").name==t})},n.prototype._prepareFileDrag=function(n,a){var i=this;i._enableDragDrop&&i._options.allow_folders&&n.bind("drop dragenter dragover",function(o){var r=o.originalEvent&&o.originalEvent.dataTransfer;if(r&&-1!==e.inArray(t,r.types))if(o.preventDefault(),"drop"==o.type){var s=r.getData(t),l=i._findByName(s);i._request(l,"rename",{file:s,destName:s,destFolder:a},function(e){l.hide("slow"),n.is(".file")&&e.file&&n.find(".info").fadeOut("normal",function(){var t=i._createFile(e.file);t.find(".info").hide().fadeIn("slow"),n.replaceWith(t)})})}else r.dropEffect="move",n.toggleClass("drag-hover",!0)}).bind("drop mouseleave dragend dragleave",function(){n.toggleClass("drag-hover",!1)})},n.prototype._createFile=function(n){var a,i,o=this,r=e('<div class="file" />').data("file",n);n.is_folder?(a=this._options.icons_url+"/folder.png",i=function(){o.navigateTo(o._currentFolder+"/"+n.name)}):(a=this._options.icons_url+"/"+n.name.split(".").pop()+".png",i=function(){var t=o._options.ajax_endpoint+(-1==o._options.ajax_endpoint.indexOf("?")?"?":"&")+"action=download&file="+n.name+"&folder="+o._currentFolder;e("<iframe>").hide().prop("src",t).appendTo("body")}),e('<div class="icon" />').click(i).append(e("<img />").attr("draggable",!1).attr("src",n.icon||a).bind("error",function(t){e(this).unbind(t).attr("src",o._options.icons_url+"/unknown.png")})).appendTo(r),e("<h4 />").attr("title",n.name).text(n.name).appendTo(r),e('<div class="info" />').html(n.info).appendTo(r);var s=e('<div class="tools" />');return n.uploading?e('<a class="btn btn-sm btn-warning cancel" />').attr("title",o._options.strings.cancel_upload).prepend('<i class="icon-cancel"></i>').appendTo(s):o._options.allow_editing&&(e('<a class="btn btn-sm btn-danger delete" />').attr("title",o._options.strings["delete"]).prepend('<i class="icon-trash"></i>').click(function(){return o._ask(o._options.strings["delete"],o._options.strings.confirm_delete,!1,function(){o._request(r,"delete",{file:n.name},function(){r.hide("slow",function(){r.remove()})})}),!1}).appendTo(s),e('<a class="btn btn-sm btn-info rename" />').attr("title",o._options.strings.rename).prepend('<i class="icon-edit"></i>').click(function(){return o._ask(o._options.strings.rename,o._options.strings.prompt_newname,n.name,function(e){n.name!=e&&o._request(r,"rename",{file:n.name,destName:e},function(e){r.fadeOut("normal",function(){var t=o._createFile(e.file).hide().fadeTo("slow",1);r.replaceWith(t)})})}),!1}).appendTo(s)),s.children().length>0&&s.appendTo(r),o._options.allow_folders&&(r.attr("draggable",!0).bind("dragstart",function(e){n.uploading||(e.dataTransfer.setData("Text",n.name),e.dataTransfer.setData(t,n.name))}),n.is_folder&&o._prepareFileDrag(r,o._currentFolder+"/"+n.name)),r},n.prototype._updateBreadcrumb=function(){if(this._options.allow_folders){var t=this,n=t.$explorer.find(".breadcrumb");n.length||(n=e('<ol class="breadcrumb" />').prependTo(t.$explorer)),n.empty();var a=(""==t._currentFolder?"/":t._currentFolder).split("/");if(""==a[0]&&""==a[1]&&a.splice(0,1),1==a.length&&this._options.autoHideBreadcrumb)n.remove();else for(var i in a){var o=0==i?t._options.strings.home_folder:a[i];if(o.length)if(i==a.length-1)n.append('<li class="active">'+o+"</li>");else{var r=a.slice(0,parseInt(i)+1).join("/"),s=e("<a />").text(o).data("folder",r).click(function(){return t.navigateTo(e(this).data("folder")),!1});n.append(e("<li />").append(s)),t._prepareFileDrag(s,r)}}}},n.prototype._validate=function(e){var t=this,n="",a=new RegExp(t._options.accept_file_types,"i");return!t._options.accept_file_types||a.test(e.type)||a.test(e.name)?e.size>t._options.max_file_size&&(n=t._options.strings.error_maxsize):n=t._options.strings.error_filetype,{success:""==n,message:n}},n.prototype._upload=function(t,n){for(var a=this,i=0;i<t.length;i++)!function(t){var i=a._createFile({name:t.name||a._options.strings.unnamed,info:t.size?(t.size/1024|0)+" KB":"",is_folder:!1,uploading:!0}).hide().appendTo(a.$files).show("slow"),o=i.addClass("uploading").attr("title",a._options.strings.uploading).find(".icon");if("undefined"!=typeof FileReader&&t.type.match("image.*")){var r=new FileReader;r.onload=function(e){var t=new Image;t.src=e.target.result,o.find("img").replaceWith(t)},r.readAsDataURL(t)}var s=a._validate(t);if(s.success){var l=!1,d=new FormData;d.append("folder",n||a._currentFolder),d.append("files[]",t);var p=a._request(i,"upload",d,function(e){l=!0,o.loader(100).loader(!1,function(){i.removeClass("uploading"),e.file&&i.replaceWith(a._createFile(e.file))})},function(){l=!0,o.loader(!1)},function(t){100==t.progress?e({val:85}).animate({val:100},{duration:3e3,step:function(){l||o.loader(this.val)}}):o.loader(.85*t.progress)});i.find(".cancel").click(function(){return p.abort(),i.hide("slow"),!1})}else a._setError(i,s.message)}(t[i])},n.prototype._ask=function(t,n,a,i,o){var r=this;if(jQuery().modal){var s=a!==!1?e("<input />",{type:"text",id:"response","class":"form-control",value:a===!0?"":a,style:"width:85%",autofocus:!0}):e(),l=e('<div class="modal fade"> <div class="modal-dialog">   <div class="modal-content">   <div class="modal-header">    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>    <h4 class="modal-title"></h4>   </div> <div class="modal-body"></div>   <div class="modal-footer">  <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>  <button type="button" class="btn btn-primary" data-dismiss="modal">Save changes</button> </div> </div></div></div>').first();l.find(".modal-title").text(t),l.find(".modal-body").text(n).append("<br/><br/>").append(s);var d=l.find(".btn-primary").text(r._options.strings.accept).click(function(){i(s.val())});l.find(".btn-default").text(r._options.strings.cancel).click(function(){o&&o()}),s.keypress(function(e){13==e.which&&(e.preventDefault(),d.click())}),l.modal("show").on("hidden",function(){l.remove()}),s.length>0?s.focus():d.focus()}else{var p=a?prompt(n,a===!0?"":a):confirm(n);p?i(p):o&&o()}},e.fn[t]=function(a){if(!e(this).length)return e(this);var i=e(this).data(t);return i&&0!=a.indexOf("_")&&i[a]&&"function"==typeof i[a]?i[a].apply(i,Array.prototype.slice.call(arguments,1)):"object"!=typeof a&&a?void e.error(i?0==a.indexOf("_")?"Method "+a+" is private!":"Method "+a+" does not exist.":"Plugin must be initialised before using method: "+a):(i=new n(e(this),a),e(this).data(t,i),e(this))}}(jQuery),function(e){e.fn.loader=function(t,n){var a=function(t,n){for(var a in n){var i=n[a];e(["-moz","-ms","-o","-webkit"]).each(function(){t[this+"-"+a]=i})}return t},i=function(e){e.css({position:"absolute",left:e.parent().width()/2-e.width()/2+"px",top:e.parent().height()/2-e.height()/2+"px"})};return e(this).each(function(){var o,r=e(this),s=r.data("loader-pie"),l=!1;if(!s||0==s.parent().length){l=!0,s=e('<div><div><div class="loader-pie"></div></div><div class="loader-pie"></div></div>').hide().prependTo(r),r.data("loader-pie",s);var d={w:r.width(),h:r.height()};o=setInterval(function(){(r.width()!==d.w||r.height()!==d.h)&&(d.w=r.width(),d.h=r.height(),r.loader(r.data("loader-progress")))},200)}r.data("loader-progress",t);var p=function(e,t){s.animate({fontSize:e},{duration:400,step:function(){i(s)},complete:function(){t&&t()}})};if(t===!1)p(0,function(){s.remove(),r.removeData("loader-pie loader-progress"),clearInterval(o),n&&n()});else{t=Math.min(t,100),r.css("position","relative");var c=Math.min(r.width(),r.height())/1.618;s.css({fontSize:c+"px",width:"1em",height:"1em",zIndex:99999}),s.children().eq(0).css({overflow:"hidden",width:".5em",height:"1em",position:"absolute",left:t>50?0:".5em"}).children().first().css(a({width:"100%",height:"100%",borderRadius:".5em 0 0 .5em",position:"absolute",left:t>50?0:"-.5em"},{"transform-origin":"right center",transform:"rotate("+3.6*t+"deg)"})),s.children().eq(1).css({display:t>50?"block":"none",width:".5em",height:"1em",borderRadius:"0 .5em .5em 0",position:"absolute",left:".5em"}),l?(s.show().css("fontSize",0),p(c)):i(s)}})}}(jQuery);