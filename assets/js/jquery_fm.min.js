!function(e){"use strict";var t="jquery_fm",n=function(t,n){return this.$T=e(t),this._options=e.extend(!0,{autoHideBreadcrumb:!1},n),this._currentFolder="/",this._enableDragDrop=window.FormData&&"draggable"in document.createElement("span"),this._init(t,n),this};n.prototype._init=function(t,n){var i=this,a=i.$fm=e('<div class="jquery_fm" />').appendTo(e(t).empty()),o=i.$explorer=e('<div class="explorer" />').appendTo(a),r=i.$files=e('<div class="files" />').appendTo(o),s=e('<div class="upload-tools" />');n.allow_upload&&(e('<a class="btn btn-success upload" />').text(n.strings.add_file).prepend('<i class="icon-plus"></i>').append(e('<input type="file" name="files[]" multiple="">').change(function(){i._upload(this.files);var t=e(this).clone(!0);e("<form></form>").append(t)[0].reset(),e(this).replaceWith(t)})).appendTo(s),i._enableDragDrop&&(jQuery.event.props.push("dataTransfer"),o.bind("drop dragenter dragover",function(t){var n=t.originalEvent&&t.originalEvent.dataTransfer;n&&-1!==e.inArray("Files",n.types)&&(t.preventDefault(),"drop"==t.type?i._upload(n.files):(n.dropEffect="copy",o.toggleClass("drag-hover",!0)))}).bind("drop mouseleave dragend dragleave",function(){o.toggleClass("drag-hover",!1)}),e('<div class="drag-drop-message" />').append('<i class="icon-download"></i>').append(n.strings.drop_files).append("<br />").append(e("<small />").text(n.strings.max_file_size.replace("%",n.max_file_size_readable))).appendTo(o)),e(document).on("paste",function(t){var n=t.originalEvent&&t.originalEvent.clipboardData&&t.originalEvent.clipboardData.items,a=[];n&&n.length&&(e.each(n,function(e,t){var n=t.getAsFile&&t.getAsFile();n&&a.push(n)}),i._upload(a))})),n.allow_folders&&e('<a class="btn btn-info folder" />').text(n.strings.create_folder).prepend('<i class="icon-folder-open"></i>').click(function(){return i._ask(i._options.strings.create_folder,i._options.strings.create_folder_prompt,!0,function(e){i._request(null,"create_folder",{name:e},function(e){e.file&&i._createFile(e.file).hide().appendTo(i.$files).show("slow")})}),!1}).appendTo(s),s.children().length>0&&a.append(s),e(n.files).each(function(){r.append(i._createFile(this))}),i._updateBreadcrumb()},n.prototype.navigateTo=function(t){var n=this;if(n._options.allow_folders){t=t.replace(/\/+/g,"/");var i=n.$explorer.find(".files").fadeOut("normal",function(){e(this).html('<div class="loader" />').fadeIn("normal")});n._request(null,"read",{folder:t},function(a){n._currentFolder=t,i.stop(!0,!0).fadeTo("normal",1).empty(),e(a.files).each(function(){n._createFile(this).hide().appendTo(n.$files).fadeTo("slow",1)}),n._updateBreadcrumb()},function(){i.stop(!0,!0).empty().append(e('<a href="#" />').text(n._options.strings.try_again).click(function(){n.navigateTo(t)}))})}return this.$T},n.prototype._request=function(t,n,i,a,o,r){var s,d=this,l={};i instanceof FormData?(s=i,s.append("action",n),l.processData=!1,l.contentType=!1):(s=e.extend({action:n},i),"undefined"==typeof s.folder&&(s.folder=d._currentFolder)),r&&(l.xhr=function(){var e=jQuery.ajaxSettings.xhr()||new window.XMLHttpRequest;return e.upload&&e.upload.addEventListener("progress",function(e){e.lengthComputable&&r({loaded:event.loaded,total:event.total,progress:event.loaded/event.total*100|0})},!1),e});var l=e.extend(l,{type:"POST",url:d._options.ajax_endpoint,data:s,dataType:"json",cache:!1,success:function(n){t&&e(t).find(".error").fadeOut("slow",function(){e(this).remove()}),a&&a(n)},error:function(){if(t)d._setError(e(t));else{var n=e("<p />").append(e('<span class="label label-danger" />').text(d._options.strings.error)).hide().prependTo(d.$fm).fadeIn();window.setTimeout(function(){n.fadeOut("slow",function(){n.remove()})},2e4)}o&&o(s)}});return e.ajax(l)},n.prototype._setError=function(t,n){var i=this,a=n||i._options.strings.error;e('<span class="error" />').text("!").attr("title",a).hide().prependTo(t).fadeOut("fast").fadeIn("fast").fadeOut("fast").fadeIn("fast").fadeOut("fast").fadeIn("fast"),t.attr("title",a).find(".cancel").remove()},n.prototype._findByName=function(t){var n=this;return n.$files.find(".file").filter(function(){return e(this).data("file").name==t})},n.prototype._prepareFileDrag=function(n,i){var a=this;a._enableDragDrop&&a._options.allow_folders&&n.bind("drop dragenter dragover",function(o){var r=o.originalEvent&&o.originalEvent.dataTransfer;if(r&&-1!==e.inArray(t,r.types))if(o.preventDefault(),"drop"==o.type){var s=o.dataTransfer.getData(t),d=a._findByName(s);a._request(d,"rename",{file:s,destName:s,destFolder:i},function(e){d.hide("slow"),n.is(".file")&&e.file&&n.find(".info").fadeOut("normal",function(){var t=a._createFile(e.file);t.find(".info").hide().fadeIn("slow"),n.replaceWith(t)})})}else r.dropEffect="move",n.toggleClass("drag-hover",!0)}).bind("drop mouseleave dragend dragleave",function(){n.toggleClass("drag-hover",!1)})},n.prototype._createFile=function(n){var i,a,o=this,r=e('<div class="file" />').data("file",n);n.is_folder?(i=this._options.icons_url+"/folder.png",a=function(){o.navigateTo(o._currentFolder+"/"+n.name)}):(i=this._options.icons_url+"/"+n.name.split(".").pop()+".png",a=function(){var t=o._options.ajax_endpoint+(-1==o._options.ajax_endpoint.indexOf("?")?"?":"&")+"action=download&file="+n.name+"&folder="+o._currentFolder;e("<iframe>").hide().prop("src",t).appendTo("body")}),e('<div class="icon" />').click(a).append(e("<img />").attr("draggable",!1).attr("src",n.icon||i).bind("error",function(t){e(this).unbind(t).attr("src",o._options.icons_url+"/unknown.png")})).appendTo(r),e("<h4 />").attr("title",n.name).text(n.name).appendTo(r),e('<div class="info" />').html(n.info).appendTo(r);var s=e('<div class="tools" />');return n.uploading?e('<a class="btn btn-sm btn-warning cancel" />').attr("title",o._options.strings.cancel_upload).prepend('<i class="icon-cancel"></i>').appendTo(s):o._options.allow_editing&&(e('<a class="btn btn-sm btn-danger delete" />').attr("title",o._options.strings["delete"]).prepend('<i class="icon-trash"></i>').click(function(){return o._ask(o._options.strings["delete"],o._options.strings.confirm_delete,!1,function(){o._request(r,"delete",{file:n.name},function(){r.hide("slow",function(){r.remove()})})}),!1}).appendTo(s),e('<a class="btn btn-sm btn-info rename" />').attr("title",o._options.strings.rename).prepend('<i class="icon-edit"></i>').click(function(){return o._ask(o._options.strings.rename,o._options.strings.prompt_newname,n.name,function(e){n.name!=e&&o._request(r,"rename",{file:n.name,destName:e},function(e){r.fadeOut("normal",function(){var t=o._createFile(e.file).hide().fadeTo("slow",1);r.replaceWith(t)})})}),!1}).appendTo(s)),s.children().length>0&&s.appendTo(r),o._options.allow_folders&&(r.attr("draggable",!0).bind("dragstart",function(e){n.uploading||(e.dataTransfer.setData("Text",n.name),e.dataTransfer.setData(t,n.name))}),n.is_folder&&o._prepareFileDrag(r,o._currentFolder+"/"+n.name)),r},n.prototype._updateBreadcrumb=function(){if(this._options.allow_folders){var t=this,n=t.$explorer.find(".breadcrumb");n.length||(n=e('<ol class="breadcrumb" />').prependTo(t.$explorer)),n.empty();var i=(""==t._currentFolder?"/":t._currentFolder).split("/");if(""==i[0]&&""==i[1]&&i.splice(0,1),1==i.length&&this._options.autoHideBreadcrumb)n.remove();else for(var a in i){var o=0==a?t._options.strings.home_folder:i[a];if(o.length)if(a==i.length-1)n.append('<li class="active">'+o+"</li>");else{var r=i.slice(0,parseInt(a)+1).join("/"),s=e("<a />").text(o).data("folder",r).click(function(){return t.navigateTo(e(this).data("folder")),!1});n.append(e("<li />").append(s)),t._prepareFileDrag(s,r)}}}},n.prototype._validate=function(e){var t=this,n="",i=new RegExp(t._options.accept_file_types,"i");return!t._options.accept_file_types||i.test(e.type)||i.test(e.name)?e.size>t._options.max_file_size&&(n=t._options.strings.error_maxsize):n=t._options.strings.error_filetype,{success:""==n,message:n}},n.prototype._upload=function(t,n){for(var i=this,a=0;a<t.length;a++)!function(t){var a=i._createFile({name:t.name||i._options.strings.unnamed,info:t.size?(t.size/1024|0)+" KB":"",is_folder:!1,uploading:!0}).hide().appendTo(i.$files).show("slow"),o=a.addClass("uploading").attr("title",i._options.strings.uploading).find(".icon");if("undefined"!=typeof FileReader&&t.type.match("image.*")){var r=new FileReader;r.onload=function(e){var t=new Image;t.src=e.target.result,o.find("img").replaceWith(t)},r.readAsDataURL(t)}var s=i._validate(t);if(s.success){var d=!1,l=new FormData;l.append("folder",n||i._currentFolder),l.append("files[]",t);var p=i._request(a,"upload",l,function(e){d=!0,o.loader(100).loader(!1,function(){a.removeClass("uploading"),e.file&&a.replaceWith(i._createFile(e.file))})},function(){d=!0,o.loader(!1)},function(t){100==t.progress?e({val:85}).animate({val:100},{duration:3e3,step:function(){d||o.loader(this.val)}}):o.loader(.85*t.progress)});a.find(".cancel").click(function(){return p.abort(),a.hide("slow"),!1})}else i._setError(a,s.message)}(t[a])},n.prototype._ask=function(t,n,i,a,o){var r=this;if(jQuery().modal){var s=i!==!1?e('<input type="text" id="response" value="'+(i===!0?"":i)+'" style="width:85%" autofocus />'):e(),d=e('<div class="modal fade">                 <div class="modal-dialog">                 <div class="modal-content">                     <div class="modal-header">                         <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>                         <h4 class="modal-title"></h4>                     </div>                     <div class="modal-body"></div>                     <div class="modal-footer">                         <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>                         <button type="button" class="btn btn-primary" data-dismiss="modal">Save changes</button>                     </div>                 </div><!-- /.modal-content -->                 </div><!-- /.modal-dialog -->                 </div><!-- /.modal -->').first();d.find(".modal-title").text(t),d.find(".modal-body").text(n).append("<br/><br/>").append(s);var l=d.find(".btn-primary").text(r._options.strings.accept).click(function(){a(s.val())});d.find(".btn-default").text(r._options.strings.cancel).click(function(){o&&o()}),s.keypress(function(e){13==e.which&&(e.preventDefault(),l.click())}),d.modal("show").on("hidden",function(){d.remove()}),s.length>0?s.focus():l.focus()}else{var p=i?prompt(n,i===!0?"":i):confirm(n);p?a(p):o&&o()}},e.fn[t]=function(i){if(!e(this).length)return e(this);var a=e(this).data(t);return a&&0!=i.indexOf("_")&&a[i]&&"function"==typeof a[i]?a[i].apply(a,Array.prototype.slice.call(arguments,1)):"object"!=typeof i&&i?void e.error(a?0==i.indexOf("_")?"Method "+i+" is private!":"Method "+i+" does not exist.":"Plugin must be initialised before using method: "+i):(a=new n(e(this),i),e(this).data(t,a),e(this))}}(jQuery),function(e){e.fn.loader=function(t,n){var i=function(t,n){for(var i in n){var a=n[i];e(["-moz","-ms","-o","-webkit"]).each(function(){t[this+"-"+i]=a})}return t},a=function(e){e.css({position:"absolute",left:e.parent().width()/2-e.width()/2+"px",top:e.parent().height()/2-e.height()/2+"px"})};return e(this).each(function(){var o,r=e(this),s=r.data("loader-pie"),d=!1;if(!s||0==s.parent().length){d=!0,s=e('<div><div><div><div class="loader-pie"></div></div><div class="loader-pie"></div></div></div>').prependTo(r),r.data("loader-pie",s);var l={w:r.width(),h:r.height()};o=setInterval(function(){(r.width()!==l.w||r.height()!==l.h)&&(l.w=r.width(),l.h=r.height(),r.loader(r.data("loader-progress")))},200)}r.data("loader-progress",t);var p=s.children().first(),c=Math.min(r.width(),r.height());t===!1?p.animate({fontSize:2*c},{duration:400,step:function(){a(p)},complete:function(){s.remove(),r.removeData("loader-pie loader-progress"),clearInterval(o),n&&n()}}):(t=Math.min(t,100),r.css("position","relative"),s.stop(!0,!0).css({overflow:"hidden",width:c+"px",height:c+"px",fontSize:c+"px",zIndex:99999}),a(s),p.css({fontSize:1/1.618+"em",width:"1em",height:"1em"}),a(p),p.children().eq(0).css({overflow:"hidden",width:".5em",height:"1em",position:"absolute",left:t>50?0:".5em"}).children().first().css(i({width:"100%",height:"100%",borderRadius:".5em 0 0 .5em",position:"absolute",left:t>50?0:"-.5em"},{"transform-origin":"right center",transform:"rotate("+3.6*t+"deg)"})),p.children().eq(1).css({display:t>50?"block":"none",width:".5em",height:"1em",borderRadius:"0 .5em .5em 0",position:"absolute",left:".5em"}),d&&s.css("fontSize",0).animate({fontSize:c},{duration:400,step:function(){a(p)}}))})}}(jQuery);